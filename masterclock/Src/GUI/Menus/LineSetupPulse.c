/*********************************************************************
*                                                                    *
*                SEGGER Microcontroller GmbH & Co. KG                *
*        Solutions for real time microcontroller applications        *
*                                                                    *
**********************************************************************
*                                                                    *
* C-file generated by:                                               *
*                                                                    *
*        GUI_Builder for emWin version 5.32                          *
*        Compiled Oct  8 2015, 11:59:02                              *
*        (c) 2015 Segger Microcontroller GmbH & Co. KG               *
*                                                                    *
**********************************************************************
*                                                                    *
*        Internet: www.segger.com  Support: support@segger.com       *
*                                                                    *
**********************************************************************
*/

// USER START (Optionally insert additional includes)
// USER END

#include "LineSetupPulse.h"
#include "timedate.h"
#include <stdbool.h>
#include "guivars.h"
#include "callbacks.h"
#include "string.h"
#include "stdio.h"
#include "stm32f4xx_hal.h"
#include "cmsis_os.h"
#include "sram.h"
#include "LineSetup.h"
#include "backup.h"

extern RTC_TimeTypeDef sTime;

/*********************************************************************
*
*       Defines
*
**********************************************************************
*/



// USER START (Optionally insert additional defines)
// USER END

/*********************************************************************
*
*       Static data
*
**********************************************************************
*/

// USER START (Optionally insert additional static data)
// USER END

/*********************************************************************
*
*       _aDialogCreate
*/
static const GUI_WIDGET_CREATE_INFO _aDialogCreate[] = {
	{ WINDOW_CreateIndirect, "Window", ID_WINDOW_LINESETUP_PULSE, 1, -3, 320, 240, 0, 0x0, 0 },
	{ BUTTON_CreateIndirect, "", ID_BUTTON_LINESETUP_PULSE_MSECplus, 5, 85, 70, 70, 0, 0x0, 0 },
	{ HEADER_CreateIndirect, "Header", ID_HEADER_LINESETUP_PULSE_VALSNAMES, 0, 40, 240, 20, 0, 0x0, 0 },
	{ HEADER_CreateIndirect, "Header", ID_HEADER_LINESETUP_PULSE_VALS, 0, 60, 240, 20, 0, 0x0, 0 },
	{ BUTTON_CreateIndirect, "", ID_BUTTON_LINESETUP_PULSE_POLplus, 85, 85, 70, 70, 0, 0x0, 0 },
	// { BUTTON_CreateIndirect, "", ID_BUTTON_2, 165, 85, 70, 70, 0, 0x0, 0 },
	 { BUTTON_CreateIndirect, "Ввод", ID_BUTTON_LINESETUP_PULSE_ENTER, 245, 85, 70, 70, 0, 0x0, 0 },
	{ BUTTON_CreateIndirect, "ВЫКЛ", ID_BUTTON_LINESETUP_PULSE_ONOFF, 245, 4, 70, 70, 0, 0x0, 0 },
	{ BUTTON_CreateIndirect, "", ID_BUTTON_LINESETUP_PULSE_MSECminus, 5, 165, 70, 70, 0, 0x0, 0 },
	{ BUTTON_CreateIndirect, "", ID_BUTTON_LINESETUP_PULSE_POLminus, 85, 165, 70, 70, 0, 0x0, 0 },
	//{ BUTTON_CreateIndirect, "", ID_BUTTON_7, 165, 165, 70, 70, 0, 0x0, 0 },
	{ BUTTON_CreateIndirect, "Назад", ID_BUTTON_LINESETUP_PULSE_BACK, 245, 165, 70, 70, 0, 0x0, 0 },
	{ HEADER_CreateIndirect, "Header", ID_HEADER_LINESETUP_PULSE_STATUS, 0, 20, 240, 20, 0, 0x0, 0 },
	{ HEADER_CreateIndirect, "Header", ID_HEADER_LINESETUP_PULSE, 0, 0, 240, 20, 0, 0x0, 0 },
	// USER START (Optionally insert additional widgets)
	// USER END
};

/*********************************************************************
*
*       Static code
*
**********************************************************************
*/

// USER START (Optionally insert additional static code)
uint8_t width[4];
uint8_t polarity[4];
// USER END

/*********************************************************************
*
*       _cbDialog
*/
static void _cbDialog(WM_MESSAGE * pMsg) {
	WM_HWIN hItem;
	int     NCode;
	int     Id;
	char str[9];
	uint8_t valsChangedOld = false;


	// USER START (Optionally insert additional variables)
	// USER END

	switch(pMsg->MsgId) {
	case WM_SEC_UPDATE:
		sprintf(str, "%02d:%02d:%02d", hoursToUTC(sTime.Hours, masterClock.daylightSaving->timeZone), sTime.Minutes, sTime.Seconds);
		TFT_LineSetupShowString(173, 17, str, 18, 0xFFFF);
		break;
	case WM_INIT_DIALOG:
		width[masterClock.guiVars->menuState - 8] = masterClock.line[masterClock.guiVars->menuState - 8].Width;
		polarity[masterClock.guiVars->menuState - 8] = masterClock.line[masterClock.guiVars->menuState - 8].Polarity;
		// Initialization of Main Window
		//
		hItem = pMsg->hWin;
		WINDOW_SetBkColor(hItem, 0x191615);
		//
		// Initialization of 'Header'
		//
		hItem = WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALSNAMES);
		HEADER_AddItem(hItem, 80, "мСек", 14);
		HEADER_AddItem(hItem, 80, "Полярн.", 14);
		HEADER_AddItem(hItem, 80, "СТАТУС:", 14);
		HEADER_SetTextColor(hItem, GUI_WHITE);
		//
		// Initialization of 'Header'
		//
		hItem = WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS);
		sprintf(str, "%4d", masterClock.line[masterClock.guiVars->menuState - 8].Width * LINE_WIDTH_MULT);
		HEADER_AddItem(hItem, 80, str, 14);

		if (masterClock.line[masterClock.guiVars->menuState - 8].Polarity)
		{
			HEADER_AddItem(hItem, 80, "Постоян.", 14);
		}
		else
		{
			HEADER_AddItem(hItem, 80, "Перемен.", 14);
		}

		switch (masterClock.line[masterClock.guiVars->menuState - 8].Status)
		{
		case LINE_STATUS_RUN:
			HEADER_AddItem(hItem, 80, "СТАРТ", 14);
			BUTTON_SetText(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ONOFF), "ВЫКЛ");
			break;
		case LINE_STATUS_STOP:
			HEADER_AddItem(hItem, 80, "СТОП", 14);
			BUTTON_SetText(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ONOFF), "ВЫКЛ");
			break;
		case LINE_STATUS_OFF:
			HEADER_AddItem(hItem, 80, "ВЫКЛ", 14);
			BUTTON_SetText(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ONOFF), "ВКЛ");
			break;

		}
		HEADER_SetTextColor(hItem, GUI_WHITE);
		//
		// Initialization of 'Header'
		//
		hItem = WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_STATUS);
		HEADER_AddItem(hItem, 160, "Время UTC(+0): ", 14);
		HEADER_AddItem(hItem, 80, "", 14);
		HEADER_SetTextColor(hItem, GUI_WHITE);
		//
		// Initialization of 'Header'
		//
		hItem = WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE);
		switch (masterClock.guiVars->menuState)
		{
		case MENU_STATE_LINE1SETUP_PULSE:
			HEADER_AddItem(hItem, 240, "Линия 1. Настройка импульса", 14);
			break;
		case MENU_STATE_LINE2SETUP_PULSE:
			HEADER_AddItem(hItem, 240, "Линия 2. Настройка импульса", 14);
			break;
		case MENU_STATE_LINE3SETUP_PULSE:
			HEADER_AddItem(hItem, 240, "Линия 3. Настройка импульса", 14);
			break;
		case MENU_STATE_LINE4SETUP_PULSE:
			HEADER_AddItem(hItem, 240, "Линия 4. Настройка импульса", 14);
			break;

		}
		HEADER_SetTextColor(hItem, GUI_WHITE);
		// USER START (Optionally insert additional code for further widget initialization)
		// USER END
		break;
	case WM_NOTIFY_PARENT:
		Id = WM_GetId(pMsg->hWinSrc);
		NCode = pMsg->Data.v;
		switch (Id) {
		case ID_BUTTON_LINESETUP_PULSE_MSECplus: // Notifications sent by 'msec_10+'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)
				if(width[masterClock.guiVars->menuState - 8] != 15)
				{
					pollButton(ID_BUTTON_LINESETUP_PULSE_MSECplus, WM_NOTIFICATION_CLICKED, (int8_t*)&width[masterClock.guiVars->menuState - 8]);
				}
				else
				{
					masterClock.longPressCNT->value = 15;
				}
				if (valsChangedOld != masterClock.guiVars->valsChanged)
				{
					WM_Invalidate(WM_GetDialogItem(masterClock.handles->hLineSetupPulseMenu, ID_BUTTON_LINESETUP_PULSE_ENTER));
				}
				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				pollButton(ID_BUTTON_LINESETUP_PULSE_MSECplus, WM_NOTIFICATION_RELEASED, (int8_t*)&width[masterClock.guiVars->menuState - 8]);
				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;
		case ID_BUTTON_LINESETUP_PULSE_POLplus: // Notifications sent by 'Pol+'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)

				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				polarity[masterClock.guiVars->menuState - 8] = 1;   //Переменная полярность
				if(valsChangedOld != masterClock.guiVars->valsChanged)
				{
					WM_Invalidate(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ENTER));
				}
				HEADER_SetItemText(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), 1, "Перемен.");
				HEADER_SetTextColor(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), GUI_WHITE);
				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;

		case ID_BUTTON_LINESETUP_PULSE_ENTER: // Notifications sent by 'Enter'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)
				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				masterClock.line[masterClock.guiVars->menuState - 8].Width = width[masterClock.guiVars->menuState - 8];
				masterClock.line[masterClock.guiVars->menuState - 8].Polarity = polarity[masterClock.guiVars->menuState - 8];
				masterClock.guiVars->valsChanged = false;
				saveLineToBKP(masterClock.guiVars->menuState - 8);

				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;
		case ID_BUTTON_LINESETUP_PULSE_ONOFF: // Notifications sent by 'OFF'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)
				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				if(masterClock.line[masterClock.guiVars->menuState - 8].Status == LINE_STATUS_OFF)
				{
					BUTTON_SetText(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ONOFF), "ВКЛ");
					masterClock.line[masterClock.guiVars->menuState - 8].Status = LINE_STATUS_STOP;
					HEADER_SetItemText(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), 2, "СТОП");
					HEADER_SetTextColor(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), GUI_WHITE);

				}
				else
				{
					BUTTON_SetText(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ONOFF), "ВЫКЛ");
					masterClock.line[masterClock.guiVars->menuState - 8].Status = LINE_STATUS_OFF;
					HEADER_SetItemText(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), 2, "ВЫКЛ");
					HEADER_SetTextColor(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), GUI_WHITE);
				}

				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;
		case ID_BUTTON_LINESETUP_PULSE_MSECminus: // Notifications sent by 'msec_10-'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)
				if(width[masterClock.guiVars->menuState - 8] != 0)
				{
					pollButton(ID_BUTTON_LINESETUP_PULSE_MSECminus, WM_NOTIFICATION_CLICKED, (int8_t*)&width[masterClock.guiVars->menuState - 8]);
				}
				if (valsChangedOld != masterClock.guiVars->valsChanged)
				{
					WM_Invalidate(WM_GetDialogItem(masterClock.handles->hLineSetupPulseMenu, ID_BUTTON_LINESETUP_PULSE_ENTER));
				}
				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				pollButton(ID_BUTTON_LINESETUP_PULSE_MSECminus, WM_NOTIFICATION_RELEASED, (int8_t*)&width[masterClock.guiVars->menuState - 8]);
				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;
		case ID_BUTTON_LINESETUP_PULSE_POLminus: // Notifications sent by 'Pol-'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)
				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				polarity[masterClock.guiVars->menuState - 8] = 0;   //постоянная полярность.
				if(valsChangedOld != masterClock.guiVars->valsChanged)
				{
					WM_Invalidate(WM_GetDialogItem(pMsg->hWin, ID_BUTTON_LINESETUP_PULSE_ENTER));
				}
				HEADER_SetItemText(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), 1, "Постоян.");
				HEADER_SetTextColor(WM_GetDialogItem(pMsg->hWin, ID_HEADER_LINESETUP_PULSE_VALS), GUI_WHITE);
				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;

		case ID_BUTTON_LINESETUP_PULSE_BACK: // Notifications sent by 'Back'
			switch(NCode) {
			case WM_NOTIFICATION_CLICKED:
				// USER START (Optionally insert code for reacting on notification message)
				// USER END
				break;
			case WM_NOTIFICATION_RELEASED:
				// USER START (Optionally insert code for reacting on notification message)
				masterClock.guiVars->menuState -= 4;
				masterClock.guiVars->valsChanged = false;
				CreateLineSetupWindow();
				WM_DeleteWindow(pMsg->hWin);
				// USER END
				break;
				// USER START (Optionally insert additional code for further notification handling)
				// USER END
			}
			break;
			// USER START (Optionally insert additional code for further Ids)
			// USER END
		}
		break;
		// USER START (Optionally insert additional message handling)
		// USER END
	default :
		WM_DefaultProc(pMsg);
		break;
	}
	valsChangedOld = masterClock.guiVars->valsChanged;
}

/*********************************************************************
*
*       Public code
*
**********************************************************************
*/
/*********************************************************************
*
*       CreateWindow
*/

WM_HWIN CreateLineSetupPulseWindow(void) {
	WM_HWIN hWin;

	hWin = GUI_CreateDialogBox(_aDialogCreate, GUI_COUNTOF(_aDialogCreate), _cbDialog, WM_HBKWIN, 0, 0);
	WM_SetCallback(WM_GetDialogItem(hWin, ID_BUTTON_LINESETUP_PULSE_MSECplus), _cbArrowUpButton);
	WM_SetCallback(WM_GetDialogItem(hWin, ID_BUTTON_LINESETUP_PULSE_POLplus), _cbArrowUpButton);
	WM_SetCallback(WM_GetDialogItem(hWin, ID_BUTTON_LINESETUP_PULSE_MSECminus), _cbArrowUpButton);
	WM_SetCallback(WM_GetDialogItem(hWin, ID_BUTTON_LINESETUP_PULSE_POLminus), _cbArrowUpButton);
	WM_SetCallback(WM_GetDialogItem(hWin, ID_BUTTON_LINESETUP_PULSE_ENTER), _cbEnterButton);
	masterClock.handles->hLineSetupPulseMenu = hWin;
	return hWin;
}

// USER START (Optionally insert additional public code)
// USER END

/*************************** End of file ****************************/
